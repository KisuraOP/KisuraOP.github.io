---
title: "【题解】六月训练日记"
sticky: 100
math: true
index_img: "https://pic.rmb.bdstatic.com/bjh/7a19545ce4313b1626c04606489150d8.jpeg"
tags:
  - XCPC
  - Codeforces
  - QOJ
categories:
  - Competitive Programming
  - Diary
excerpt: 你怎么知道我上紫了？
abbrlink: a62f5f49
date: 2025-06-26 21:00:00
updated: 2025-06-26 21:00:00
---


## [QOJ9748. 最大公因数的平方和](https://qoj.ac/contest/1841/problem/9748)

[Code](https://qoj.ac/submission/1086982)

由莫比乌斯反演，令 $g(n)=n^2=\sum\limits_{d\mid n}f(d)$，则 $f(n)=\sum\limits_{d\mid n}\mu(d)g\left(\dfrac{n}{d}\right)=\sum\limits_{d\mid n}\mu(d)\left(\dfrac{n}{d}\right)^2$。

我们可以在调和级数复杂度内预处理出所有的 $f(n)$。

于是，原式化为
$$
\begin{align}
\sum_{i=l}^{r}\sum_{j=L}^{R}\gcd(a_i,b_j)^2
&=\sum_{i=l}^{r}\sum_{j=L}^{R}\sum_{d\mid \gcd(a_i,b_j)}f(d)\\
&=\sum_{i=l}^{r}\sum_{j=L}^{R}\sum_{d\mid a_i\land d\mid b_j}f(d)\\
&=\sum_{d=1}^{n}f(d)\sum_{i=l}^{r}[d\mid a_i]\sum_{j=L}^{R}[d\mid b_j]
\end{align}
$$
后两项形式相同，我们以 $\sum\limits_{i=l}^{r}[d\mid a_i]$ 为例，相当于问一段区间内有多少个数是某个值 $d$ 的倍数。

阈值分治，设阈值为 $B$。那么当 $d\le B$ 时，我们可以对每个 $d$ 处理出一个前缀和，这样每个询问就可以 $O(1)$ 查询。这部分是 $O(nB+qB)$ 的。

而 $d>B$ 时，把这个倍数在 $\{a\}$ 中的下标记作 $i$，在 $\{b\}$ 中的下标记作 $j$。可以看成如下二维数点问题：

- 二维平面上有若干个点，每个点的坐标是 $(i,j)$，有一个权值 $f(d)$。
- 有若干询问，每个询问形如：在一个矩形区域内所有点的权值和。

利用分块进行二维数点，这部分是 $O(\dfrac{n^2}{B^2}+q\sqrt{n})$ 的。

## [QOJ9476. 012 Grid](https://qoj.ac/contest/1812/problem/9476)

[Code](https://qoj.ac/submission/1085839)

先引用四张官方题解的图片。

![](/image/academic/qoj9476_1.png)

![](/image/academic/qoj9476_2.png)

不难发现，题目的约束等同于找两条从左下到右上的路径，这两条路径分别分割了 $0/1$ 以及 $1/2$，严格不相交。其中前两幅图路径起点都是 $(0,1)$ 和 $(1,0)$，终点都是 $(n,m-1)$ 和 $(n-1,m)$。而后两幅图可以提取出一个子矩形（红圈框起来），只研究这个子矩形的话和前两幅图无异。

于是我们先研究前两幅图的情况。回忆 LGV 引理，有向无环图上，给定 $k$ 个起点 $\{a_1,a_2,\ldots,a_k\}$ 和 $k$ 个终点 $\{b_1,b_2,\ldots,b_k\}$，那么要满足 $a_i\to b_i$ 这 $k$ 条路径严格互不相交，方案数是：
$$
\det\pmatrix{e(a_1,b_1) & e(a_1,b_2) & \cdots & e(a_1,b_k)\\
e(a_2,b_1) & e(a_2,b_2) & \cdots & e(a_2,b_k)\\
\vdots & \vdots & \ddots & \vdots\\
e(a_k,b_1) & e(a_k,b_2) & \cdots & e(a_k,b_k)
}
$$
其中 $e(a_i,b_j)$ 表示从 $a_i$ 到 $b_j$ 所有路径的权重之和。再者，一条路径的权重定义为路径上所有边权之积。于是，当图中所有边权都是 $1$ 时，$e(a_i,b_j)$ 就等价于从 $a_i$ 到 $b_j$ 有多少条不同的路径。再回忆，网格图上，如果只朝右或朝上走（这样相当于有向无环图），那么从点 $P(x_1,y_1)$ 到 $Q(x_2,y_2)$ 有 $\dbinom{|x_1-x_2|+|y_1-y_2|}{|x_1-x_2|}$ 种不同的走法（插板法），故 $e(P,Q)= \dbinom{|x_1-x_2|+|y_1-y_2|}{|x_1-x_2|}$。

回到本题，$k=2$，起点分别为 $(0,1),(1,0)$，终点分别为 $(n,m-1),(n-1,m)$，那么严格不相交路径数等于
$$
\det\pmatrix{\dbinom{n+m-2}{n} & \dbinom{n+m-2}{n-1}\\
\dbinom{n+m-2}{n-1} & \dbinom{n+m-2}{m}
}
=
\frac{(n+m-2)!(n+m-1)!}{n!m!(n-1)!(m-1)!}
$$
这个组合数展开花了我相当多的时间，可能需要一点技巧（

好，现在我们看向后两幅图，我们现在要枚举那个红框框起来的区域。观察这两幅图，左边这幅子矩形贴着右侧和下侧，我们称这种情况为 "右下"，同理右边这幅是 "左右" 的情况。

于是，共有左上、右下、左右、上下四种情况，后两种比较平凡，枚举矩形的长/宽，乘这样尺寸的矩形有几个，再累加即可。

对于前两种，矩形的长和宽都需要枚举，相当于求一个这样的式子
$$
\sum_{i=1}^{n}\sum_{j=1}^{m}\frac{(i+j-2)!(i+j-1)!}{i!j!(i-1)!(j-1)!}
$$
分子的形式引起我们注意，令 $p=i+j$，原式化为
$$
\sum_{p=2}^{n+m}(p-2)!(p-1)!
\sum_{i+j=k}
\underbrace{\frac{1}{i!(i-1)!}}_{\Large f_i}
\cdot 
\underbrace{\frac{1}{j!(j-1)!}}_{\Large g_j}
$$
后面那项用 NTT 卷积即可。

时间复杂度 $O((n+m)\log (n+m))$。

## [QOJ9479. And DNA](https://qoj.ac/contest/1812/problem/9479)

[Code](https://qoj.ac/submission/1094637)

定义 $f_n(m)$：长度为 $n$ 的序列 $\{a\}$，满足 $\forall i\in [1,n]$，$a_i+(a_{i-1}\&a_{i+1})=m$ 的序列数量。

先思考 $m$ 比较小的情况。

当 $m=0$ 时，只有全 $0$ 序列能满足要求，故 $f_n(0)=1$。

当 $m=1$ 时，$\{a\}$ 只能是 $01$ 序列。根据定义易知 $\{a\}$ 需要满足 "没有连续两个 $0$" 且 "没有连续三个 $1$"。

这等价于在下述状态机中，从任意一个顶点出发，经过 $n$ 条边回到同一顶点的路径条数。

![](/image/academic/qoj9479.png)

邻接矩阵配合矩阵快速幂，可以在 $O(\log n)$ 内解决。

当 $m$ 为 $\ge 2$ 的偶数时，草稿纸上画一下，易知此时 $\{a\}$ 要么全是偶数，要么全是奇数。

- 当 $\{a\}$ 全为偶数时，令 $a_i=2b_i$，方程变为 $2b_i+(2b_{i-1}\&2b_{i+1})=m$。由位运算的性质，括号里的 $2$ 可以提出来，于是方程化为 $b_i+(b_{i-1}\&b_{i+1})=\dfrac{m}{2}$。这是一个规模更小的问题，即 $f_n(\dfrac{m}{2})$。
- 当 $\{a\}$ 全为奇数时，令 $a_i=2b_i+1$，代入方程，同样能推导出 $b_i+(b_{i-1}\&b_{i+1})=\dfrac{m}{2}-1$。

故 $f_n(m)=f_n(\dfrac{m}{2})+f_n(\dfrac{m}{2}-1)$。

当 $m$ 为 $\ge 3$ 的奇数时，换一个视角，在计算 $a_i+(a_{i-1}\&a_{i+1})$ 时二进制下最低位一定不会产生进位。

这允许我们将最低位和高位部分分开计算，两部分独立，方案数可以乘起来。

- 最低位部分，$a_i^{(low)}+(a_{i-1}^{(low)}\&a_{i+1}^{(low)})=1$，即 $f_n(1)$。
- 高位部分，把末尾的 $1$ 除掉之后剩下 $\dfrac{m-1}{2}$，即 $f_n(\dfrac{m-1}{2})$。

故 $f_n(m)=f_n(1)\times f_n(\dfrac{m-1}{2})$。

时间复杂度 $O(\log n+\log m)$。

## [QOJ9488. Do Not Turn Back](https://qoj.ac/contest/1812/problem/9488)

[Code](https://qoj.ac/submission/1094352)

将 "不连续走同一条边" 的条件称为 $(*)$ 条件。

定义一个 $N\times N$ 的方阵 $X_k$：$X_k[i][j]$ 表示从 $i$ 到 $j$ 长度为 $k$ 且满足 $(*)$ 的路径数量。

于是答案即为 $X_k[1][n]$。

同样定义以下几个 $N\times N$ 的矩阵：

- $A$：图 $G$ 的邻接矩阵。
- $D$：图 $G$ 的度数矩阵。（对角矩阵，对角线上的元素为对应顶点的度数）
- $I$：单位矩阵。
- $O$：零矩阵。

接下来看怎么推导出 $X_k$。

当 $k = 1$ 时，显然有 $X_1=A$。

当 $k=2$ 时，若不考虑 $(*)$，答案是 $A^2$。而不满足 $(*)$ 的路径形如 $i\to j\to i$，这样的路径有 $\text{deg}(i)$ 条，于是 $X_2=A^2-D$。

当 $k\ge 3$ 时，同样考虑从 $AX_{k-1}$ 中减去不满足 $(*)$ 的部分。

考虑 $AX_{k-1}$ 的含义是所有长度为 $k-1$ 的合法路径再往前走一步。对于一条路径：
$$
a_0\to \ldots \to a_{k-3}\to a_{k-2}\to a_{k-1}
$$
不满足 $(*)$ 的路径形如，从 $a_{k-2}$ 开始走一段 $i\to j\to i\ (i=a_{k-2})$。其中 $j$ 的选择有 $\text{deg}(i)-1$ 种，减一是因为前面的路径合法保证了 $j$ 不能是 $a_{k-3}$。于是，不满足 $(*)$ 的路径数有 $(D-I)X_{k-2}$ 这么多。

也就是说，$X_k=AX_{k-1}-(D-I)X_{k-2},\ k\ge 3$。

写成矩阵快速幂的形式
$$
\pmatrix{X_k\\X_{k-1}}=\pmatrix{A & -(D-I)\\ I & O}\pmatrix{X_{k-1}\\ X_{k-2}}
$$
即
$$
\pmatrix{X_k\\X_{k-1}}=\pmatrix{A & -(D-I)\\ I & O}^{k-2}\pmatrix{X_2\\ X_1}
$$
时间复杂度 $O(N^3\log K)$。

## [QOJ10346. Make Triangle](https://qoj.ac/contest/1967/problem/10346)

[Code](https://qoj.ac/submission/1105077)

令 $S=\sum x_i$，三个集合分别为 $A, B, C$，则题目可以转化为给出 $\{x\}$ 的一个三集合划分使得 $|A|=n_a$，$|B|=n_b$，$|C|=n_c$ 且 $\min\left(\sum\limits_{x\in A}x,\sum\limits_{x\in B}x,\sum\limits_{x\in C}x\right) < \dfrac{S}{2}$。

在以下叙述中，默认 $x_1\le x_2 \le \ldots\le x_n$ 且 $n_a\le n_b\le n_c$。

下面是一些必要条件

- 最大的元素不能太大：$x_n+\sum\limits_{i=1}^{n_a-1}x_i<\dfrac{S}{2}$。
- 最大的组要装得下最小的几个元素：$\sum\limits_{i=1}^{n_c}x_i<\dfrac{S}{2}$。

可以证明这个条件是充分的。但我们选择证明一个比上述条件更强的引理。

*Lemma.* 如果我们按 $\{x_i\}$ 从大到小选择它们应该放进的集合（即当前需要放置的元素比任何已经在集合里的元素都要小），设 $n'$ 表示还没放的数的个数（即 $x_1,x_2,\ldots,x_{n'}$），$n_a'$，$n_b'$，$n_c'$ 表示三个集合的剩余容量（满足 $n_a'+n_b'+n_c'=n'$），$S_a$，$S_b$，$S_c$ 表示三个集合已经装进的数的和，则剩下的这 $n'$ 个数能合法塞进三个集合的**充要**条件是：

- $\exists g\in \{a,b,c\}$，$S_g+x_{n'}+\sum\limits_{i=1}^{n_g'-1}x_i<\dfrac{S}{2}$。
- $\forall g\in \{a,b,c\}$，$S_g+\sum\limits_{i=1}^{n_g'} < \dfrac{S}{2}$。

*Prove.* 必要性显然，这里证充分性。我们不妨令集合 $A$ 满足第一个条件，那么 $S_a+x_{n'}+\sum\limits_{i=1}^{n_a'-1}x_i<\dfrac{S}{2}$。

此时将 $x_{n'}$ 放进 $A$ 中，剩下的 $x_1\sim x_{n'-1}$ 任意放进 $B,C$ 中。设如此操作后有 $S_a'$，$S_b'$ 和 $S_c'$，则若 $S_b'<\dfrac{S}{2}$ 且 $S_c'<\dfrac{S}{2}$，那么我们就已经找到了一组合法划分。否则，$\max(S_b',S_c')\ge \dfrac{S}{2}$，不失一般性，我们令 $S_b'\ge \dfrac{S}{2}$。

此时，$S_a'+S_c'<\dfrac{S}{2}$，我们可以任意交换 $A,C$ 中的元素（除 $x_{n'}$ 外）。现在，观察如果任意交换 $B,C$ 中的元素，会发生什么情况。在一次交换中，换进 $C$ 的元素 $<x_{n'}$，换出 $C$ 的元素 $\ge 1$，那么 $C$ 中元素的和最多增长 $x_{n'}-1$。而交换前 $S_c'\le S-S_b'-S_a'\le \dfrac{S}{2}-S_a'\le \dfrac{S}{2}-x_{n'}$。

意思是，交换后 $S_c''\le S_c'+(x_{n'}-1)\le \dfrac{S}{2}-x_{n'}+(x_{n'}-1)<\dfrac{S}{2}$。

也就是说，$B,C$ 也可以任意交换，再加上 $A,C$ 可以任意交换，所有元素都可以在三个集合之间调整，直到 $S_b'<\dfrac{S}{2}$。又因为 Lemma 的第二个条件的存在，保证了一定能调整出来。故该引理得证。

好的，现在我们拥有了这个 Lemma，做法也就呼之欲出了：从大到小分配 $\{x\}$ 中的元素，逐一尝试分配到 $A,B,C$ 中，看一下某次尝试后，Lemma 的条件是否满足。若满足，就分配。若无论分配到哪一个集合都无法满足 Lemma，就无解。

时间复杂度 $O(n)$。

## [QOJ9851. Cup of Water](https://qoj.ac/contest/1870/problem/9851)

[Code](https://qoj.ac/submission/1120501)